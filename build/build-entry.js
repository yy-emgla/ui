'use strict'
const fs = require('fs')
const path = require('path')
const glob = require('glob')
const version = require('../package.json').version
const endOfLine = require('os').EOL

module.exports = function () {
  const files = glob.sync('./src/components/*/index.*')
  const pluginFiles = glob.sync('./src/plugins/*/index.*')
  const include = [], components = [], plugins = []

  files.forEach(file => {
    const name = file.match(/components\/([^/]+)/)[1]
    const m = name.replace(/^\w|-\w/g, w => w[1] ? w[1].toUpperCase() : w.toUpperCase())

    include.push(`import ${m} from './components/${name}'`)

    components.push(m)
  })

  pluginFiles.forEach(file => {
    const name = file.match(/plugins\/([^/]+)/)[1]
    const m = name.replace(/^\w|-\w/g, w => w[1] ? w[1].toUpperCase() : w.toUpperCase())

    include.push(`import ${m}Plugin from './plugins/${name}'`)

    plugins.push(`${m}Plugin`)
  })

  const index = `/* Automatic generated by ./build/build-entry.js */

${include.join(';' + endOfLine)};

import locale from './locale';

const version = '${version}';

const install = (Vue) => {
  locale.init(Vue);

  ${components.map(o => `Vue.component('Ui${o}', ${o})`).join(`;${endOfLine}  `)};

  ${plugins.map(o => `Vue.use(${o})`).join(`;${endOfLine}  `)};
};

/* istanbul ignore if */
if (typeof window !== 'undefined' && window.Vue) {
  install(window.Vue);
}

export {
  ${components.join(`,${endOfLine}  `)},
};

export default {
  version,
  install,
};
`
  fs.writeFileSync(path.resolve(__dirname, '../src/index.js'), index)
}
